<!doctype html> 
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
	<title>Phaser - Making your first game, part 1</title>
	<script type="text/javascript" src="js/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var game = new Phaser.Game(900, 400, Phaser.AUTO, 'game_window');
var mainState = {
 preload: function() {
    game.load.image('background', 'assets/background.jpg');
    game.load.image('witch', 'assets/witch.png');
    game.load.image('ground', 'assets/platform.png');
    game.load.image('tomb', 'assets/tombstone.png')
},

 create:function() {
    game.physics.startSystem(Phaser.Physics.ARCADE);

    //assets
    this.background = game.add.tileSprite(0,-10, game.world.width, game.world.height, 'background');

    //other wichcrafty
    this.platforms = game.add.group();
    this.obstacles = game.add.group();


    this.platforms.enableBody = true;
    this.ground = this.platforms.create(0, game.world.height - 30, 'ground');
    this.ground.scale.setTo(3,3);
    this.ground.body.immovable = true;

    this.witch = game.add.sprite(game.width * .05, this.ground.y, 'witch');


    //POWER FOR THE JUMP
    this.power = 0;
    this.powerBar = game.add.sprite(this.witch.x + 25, this.witch.y - 25, "bar");
    this.powerBar.width = 0;

    this.spacebar = game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR);
    this.spacebar.onUp.add(this.keyUp, this);
    this.spacebar.onDown.add(this.keyDown, this);


    //touch events
    game.input.onUp.add(this.keyUp, this);
    game.input.onDown.add(this.keyDown, this);

    //bloody physics
    
    game.physics.startSystem(Phaser.Physics.ARCADE);
    game.physics.enable(this.witch, Phaser.Physics.ARCADE);

    //withcy physics
    this.witch.body.gravity.y = 500;
    this.witch.body.collideWorldBounds = true;
    this.witch.body.bounce.set(0, .3);
    
    this.powerBar.visible = false;
    this.ground.visible = false;

    
    this.score = 0;
    this.labelScore = game.add.text(20, 20, "0", 
    { font: "30px Arial", fill: "#ffffff" });   

    var rnd = game.rnd.integerInRange(3, 8);
    var time_rnd = game.rnd.integerInRange(4, 6) * 100;
    this.timer = game.time.events.loop(time_rnd * rnd, this.addOneObstacles, this); 

    
},

 keyDown : function() {
    this.timer = game.time.events.loop(Phaser.Timer.SECOND / 1000, this.increasePower, this);
    },

 keyUp : function() {
        this.doJump();
        game.time.events.remove(this.timer);
        this.power = 0;
        this.powerBar.width = 0;
    },

 increasePower : function() {
    this.power++;
    this.powerBar.width = this.power;
        if (this.power < 50) {
            this.power = 50;
        }
},


 doJump : function() {
    this.witch.body.velocity.y = -this.power * 7;
    // Jump animation
    game.add.tween(this.witch).to({angle: -20}, 100).start();

        // Play sound
        // this.jumpSound.play();
    },

 addOneObstacles: function(x, y) {

    this.score += 1;
    this.labelScore.text = this.score; 
        // Create a pipe at the position x and y
        var obstacle = game.add.sprite(900, 283, 'tomb');
    
        // Add the pipe to our previously created group
        this.obstacles.add(obstacle);
    
        // Enable physics on the pipe 
        game.physics.arcade.enable(obstacle);
    
        // Add velocity to the pipe to make it move left
        obstacle.body.velocity.x = -300; 
    
        // Automatically kill the pipe when it's no longer visible 
        obstacle.checkWorldBounds = true;
        obstacle.outOfBoundsKill = true;
    },

 update : function() {
    //obstacles.x--;
    this.background.tilePosition.x = this.background.tilePosition.x - 5;
    // obstacles.x = obstacles.x -5;

    game.physics.arcade.overlap(
        this.witch,this.obstacles, this.restartGame, null, this);

    if (this.witch.angle < 20 )
        this.witch.angle += 1; 
    
    if (this.witch.angle > 20)
        this.witch.angle -= 1; 
},

 restartGame : function(){
    game.state.start('over');
}
};

var gameoverState = {

    preload: function(){
        game.load.image('background', 'assets/end.jpg');
        game.load.image('restart', 'assets/restart.png');
    },

    create: function () {
        this.background = game.add.tileSprite(0,-10, game.world.width, game.world.height, 'background');
        //this.gameoverLabel = stateText = game.add.text(600, 200, ' ', {font: '50px Arial', fill: '#FFF'});
        //stateText.anchor.setTo(1.1, 0.2);
        this.score = game.add.text(game.world.centerX + 90, 200, '', {font: '20px Arial', fill: '#FFF'});
        this.restartButton = game.add.button(100, 100, 'restart', this.restartGame, this, 0, 0, 0);
    
    },

    update: function () {

            //stateText.text = " GAME OVER. \n Your score is " + mainState.score + "\n Click to restart" ;
            //stateText.visible = true;

  
            // game.input.onDown.addOnce(function () {
            // game.state.start('main');});
        },

    restartGame: function(){
        game.state.start('main'); 
    }
    
    
};
game.state.add('main', mainState);  
game.state.add('over', gameoverState)
game.state.start('main'); 
</script>

</body>
</html>


